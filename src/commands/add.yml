description: >-
  This command will add a rule in the SG of the AWS Security Group to allow the
  ingress of the CircleCI Machine
parameters:
  description:
    description: Description to identify the rule.
    type: string
    default: CircleCI
  port:
    description: Port to open for the inbound rule.
    type: integer
    default: 443
  mask:
    description: Mask to use for the ip address.
    type: integer
    default: 32
  group-id:
    description: Specifies the ID of the security group.
    type: string
    default: ''
  tag-key:
    description: This key should exist in the SG where we are going to add the rules.
    type: string
    default: developers
  tag-value:
    description: >-
      This value should exist in the tag of the SG where we are going to add the
      rules.
    type: string
    default: bastionaccess
steps:
  - aws-cli/install
  - run:
      name: AWS whitelist add CircleCI IP
      command: >
        LATEST_IP=$(wget -qO- http://checkip.amazonaws.com)
        IP="${IP-$LATEST_IP}"
        if [ -z "${IP}" ]; then
          echo "Could not find your public IP"
          exit 1
        fi

        echo "-----------------------"
        echo "<<parameters.group-id>>"
        echo "-----------------------"

        if [ -z "<<parameters.group-id>>" ];then
          GROUPID=$(${AWS_COMMAND} ec2 describe-security-groups \
            --query 'SecurityGroups[].[Tags[?Key==`<<parameters.tag-key>>`] | [0].Value, GroupId]' \
            --output text | grep ${PARAM_TAG_VALUE} | awk '{print $2}')
          [[ -n "${GROUPID}" ]] || (echo "Could not determine Security Group ID" && exit 0);
        fi

        echo "Allowing CircleCI to access port <<parameters.port>> from IP ${IP} to the security group ${GROUPID}"
        ${AWS_COMMAND} ec2 authorize-security-group-ingress \
          --group-id "${GROUPID}" \
          --ip-permissions '[{"IpProtocol": "tcp", "FromPort": <<parameters.port>>, "ToPort": <<parameters.port>>, "IpRanges": [{"CidrIp": "${IP}/<<parameters.mask>>", "Description": "<<parameters.description>>"}]}]'
